{% extends 'catalog/base.html' %}
{% load custom_tags %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white shadow-md rounded-md p-6 mt-6">
    <!-- Course Title -->
    <h1 class="text-3xl font-bold text-gray-800 mb-4">{{ course.title }}</h1>

    <!-- Course Details -->
    <p class="mb-2"><span class="font-medium text-gray-600">Instructor:</span> {{ course.instructor }}</p>
    <p class="mb-‚ÄôO2"><span class="font-medium text-gray-600">Category:</span> {{ course.category.name }}</p>
    <p class="text-gray-700 mb-6">{{ course.description }}</p>

    <!-- Enroll / Completion / Certificate -->
    {% if user.is_authenticated %}
        {% if not enrolled %}
            <form action="{% url 'enroll_course' course.pk %}" method="post" class="mb-4">
                {% csrf_token %}
                <button 
                    type="submit" 
                    class="bg-blue-600 text-white px-5 py-2 rounded-md hover:bg-blue-700 transition"
                >
                    Enroll
                </button>
            </form>
        {% endif %}

        {% for enrollment in user.enrollment_set.all %}
            {% if enrollment.course.id == course.id %}
                {% if not enrollment.is_completed %}
                    <form action="{% url 'mark_completed' course.pk %}" method="post" class="mb-6">
                        {% csrf_token %}
                        <button 
                            type="submit" 
                            class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700 transition"
                        >
                            Mark as Completed
                        </button>
                    </form>
                {% else %}
                    <div class="mb-6">
                        <a href="{% url 'download_certificate' course.pk %}" 
                           class="bg-purple-600 text-white px-5 py-2 rounded-md hover:bg-purple-700 transition inline-block">
                            üéì Download Certificate (PDF)
                        </a>
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}

        {% if enrolled %}
            <!-- Unified Course Progress Bar -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-1">Course Progress</h4>
                <div class="w-full bg-gray-200 rounded h-5">
                    <div class="bg-green-500 h-5 rounded" style="width: {{ progress }}%;"></div>
                </div>
                <p class="text-sm text-gray-700 mt-1">{{ progress }}% Complete</p>
            </div>
        {% endif %}
    {% elseÊé†
        <p class="mb-6">
            <a href="{% url 'login' %}" class="text-blue-600 hover:underline">Login to enroll</a>
        </p>
    {% endif %}

    <!-- Lessons Section -->
    <hr class="my-6">
    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Lessons</h3>
    <ul class="space-y-6 mb-6">
        {% for lesson in course.lessons.all %}
            <li class="bg-gray-50 border p-4 rounded-md">
                <p class="font-semibold text-gray-800 text-lg mb-1">{{ lesson.title }}</p>
                <p class="text-gray-700 mb-2">{{ lesson.content }}</p>

                {% if lesson.video %}
                    <div class="mb-3">
                        <video width="100%" controls class="rounded">
                            <source src="{% url 'stream_video' lesson.id %}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                {% endif %}

                {% if user.is_authenticated %}
                    {% with progress=lesson_progress_map|dict_get:lesson.id %}
                        {% if progress and progress.completed %}
                            <span class="text-green-600 text-sm font-medium">‚úÖ Completed</span>
                        {% else %}
                            <form action="{% url 'mark_lesson_complete' lesson.id %}" method="post" class="inline-block mt-2">
                                {% csrf_token %}
                                <button 
                                    type="submit" 
                                    class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition"
                                >
                                    Mark as Complete
                                </button>
                            </form>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            </li>
        {% empty %}
            <li class="text-gray-500">No lessons added yet.</li>
        {% endfor %}
    </ul>

    <!-- Course Forum -->
    <div class="mb-6">
        <a href="{% url 'course_forum' course.pk %}" class="text-blue-600 hover:underline font-semibold">
            üí¨ Go to Course Forum
        </a>
    </div>

    <!-- Reviews -->
    <hr class="my-6">
    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Reviews</h3>
    <ul class="space-y-4 mb-6">
        {% for review in reviews %}
            <li class="bg-gray-100 p-4 rounded-md">
                <p class="text-sm text-gray-700 mb-1">
                    <strong>{{ review.user.username }}</strong> 
                    <span class="text-gray-500 text-xs">({{ review.created_at|date:"Y-m-d H:i" }})</span>
                </p>
                <p class="text-gray-800">{{ review.comment }}</p>
            </li>
        {% empty %}
            <li class="text-gray-500">No reviews yet.</li>
        {% endfor %}
    </ul>

    <!-- Leave a Review -->
    {% if user.is_authenticated %}
        <h4 class="text-xl font-semibold text-gray-800 mb-2">Leave a Review</h4>
        <form method="post" action="{% url 'course_detail' course.pk %}" class="space-y-4 mb-6">
            {% csrf_token %}
            {{ form.as_p }}
            <button 
                type="submit" 
                class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700 transition"
            >
                Post Review
            </button>
        </form>
    {% else %}
        <p class="mb-6">
            <a href="{% url 'login' %}" class="text-blue-600 hover:underline">Login to write a review</a>
        </p>
    {% endif %}

    <!-- Course Announcements -->
    <hr class="my-6">
    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Course Announcements</h3>
    <ul class="space-y-4 mb-6">
        {% for ann in announcements %}
            <li class="bg-gray-50 p-4 rounded-md">
                <p class="text-sm text-gray-700 mb-1">
                    <strong>{{ ann.title }}</strong> 
                    <span class="text-gray-500 text-xs">({{ ann.created_at|date:"Y-m-d" }})</span>
                </p>
                <p class="text-gray-800">{{ ann.message }}</p>
            </li>
        {% empty %}
            <li class="text-gray-500">No announcements yet.</li>
        {% endfor %}
    </ul>

    <!-- Upcoming Live Classes -->
    <hr class="my-6">
    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Upcoming Live Classes</h3>
    <ul class="space-y-4 mb-6">
        {% for live in course.live_classes.all %}
            <li class="bg-gray-50 p-4 rounded-md">
                <p class="text-sm text-gray-700 mb-1">
                    <strong>{{ live.topic }}</strong> 
                    <span class="text-gray-500 text-xs">({{ live.start_time|date:"Y-m-d H:i" }})</span>
                </p>
                {% if enrolled %}
                    <a href="{{ live.zoom_link }}" target="_blank" class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition inline-block">
                        Join
                    </a>
                {% endif %}
            </li>
        {% empty %}
            <li class="text-gray-500">No live classes scheduled.</li>
        {% endfor %}
    </ul>

    <!-- Back to Courses -->
    <a href="{% url 'course_list' %}" class="text-sm text-gray-600 hover:underline">‚Üê Back to Courses</a>
</div>
{% endblock %}